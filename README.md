# MakeDevice-backend
When given a custom device design by the [MakeDevice frontend](https://github.com/devices-lab/MakeDevice-new), this server performs PCB auto-routing between modules, and generates:
- Gerber files & drill data for PCB manufacture
- BOM and CPL files for PCB assembly
- Device firmware for commissioning

<img width="600" alt="image" src="https://github.com/user-attachments/assets/4c059e1b-21aa-4fe3-931e-b6472c02da5c" />

<img width="600" src="https://github.com/user-attachments/assets/603726ab-d6e2-4ed4-a5c3-d4bd21213c41" />
<br><br>

Make sure to use up-to-date `backend_module_data/` generated by [MakeDevice modules](https://github.com/devices-lab/MakeDevice-modules)

## Setup (docker)

On each push to main, a github workflow builds a docker image. This can be downloaded to run the production server locally with no setup.
1. Start the docker service `sudo service docker start`
2. Pull the latest container package `docker pull ghcr.io/devices-lab/makedevice-backend:latest`
3. Run the container `docker run -p 3333:3333 ghcr.io/devices-lab/makedevice-backend:latest`

>[!CAUTION]
> To free up space by permanently deleting ALL docker containers, images, volumes (not just MakeDevice ones), you can run `docker system prune --all --volumes --force`

## Setup (manual)

Alternatively, the python code can be run by following these steps

### 1. Install dependencies for `objcopy` and `picotool`
```sh
sudo apt-get install \
    binutils \
    build-essential \
    cmake \
    git \
    libusb-1.0-0-dev \
    pkg-config \
    gcc-arm-none-eabi \
    libnewlib-arm-none-eabi \
    libstdc++-arm-none-eabi-newlib
```


### 2. Install `picotool` to `./picotool/` (using temporary dependency `pico-sdk`)
```sh
git clone --depth=1 https://github.com/raspberrypi/pico-sdk.git pico-sdk && \
    git clone https://github.com/raspberrypi/picotool.git picotool && \
    cd picotool && mkdir build && cd build && \
    cmake .. -DPICO_SDK_PATH=../../pico-sdk && \
    make && \
    rm -rf ../../pico-sdk && cd ../..
```

### 3. Switch to python 3.11
You must use Python version `3.11`, or lower, otherwise it won't work with some outdated dependencies (such as `gerbonara`). To control Python versions you may use the `pyenv` tool.

1. `brew install pyenv`
2. `pyenv install 3.11.0`
3. `pyenv global 3.11.0` to set globally or `pyenv local 3.11.0` to set in the current directory.

In the case this tools doesn't change your Python version (happens on an M-chip Mac), add `eval "$(pyenv init --path)"` to your ~/.zshrc and re-open the terminal.

### 4. Install dependencies to a virtual python environment
1. Create a virtual environment with `python3 -m venv venv`
2. Activate it with `source venv/bin/activate`
3. Install dependencies `python3 -m pip install -r requirements.txt`

## Usage
### Running an offline test-case (currently broken)

1. Activate the virtual python environment with `source venv/bin/activate`
2. Run an offline test case for a JSON from `data/`, such as `python3 run.py office-vm_net_map_0.3`
 - You could instead run `python3 run.py office-vm_net_map_0.3 video` to generate a video of the test case

### Running as a server

1. Activate the virtual python environment with `source venv/bin/activate`
2. Run the Flask development server with `python3 -u server.py`
 - Alternatively, run the production server with `gunicorn server:app --workers 4 --bind 0.0.0.0:3333 --capture-output --log-level debug`

## Visual Debugger

To run the interactive visual debugger for step-by-step routing analysis:

```sh
venv/bin/python -u debug_visual_run.py --job-id 67676767 
```
Replace --job-id with the correct id, or omit --job-id to use latest job.

The debugger provides:
- **Interactive visualization** of all routing elements (board, zones, traces, buses, sockets, vias, keep-out areas)
- **Step-by-step control**: Press Space/Enter/n to advance, c to continue, p to pause, q to quit
- **Element inspection**: Click on any trace, socket, zone, bus, or via to see detailed information
- **Event log**: Shows routing events since the last step
- **Routing status**: Displays progress with duplicate socket detection

## Other 

There is a GitHub project (Kanban board) for [MakeDevice planning](https://github.com/orgs/devices-lab/projects/1), with features and their integration status.
